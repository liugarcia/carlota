<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Modal Example</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <div class="navbar">
        <div id="wallet" class="wallet">
            <w3m-button id="connect">Connect Wallet</w3m-button>
            <div id="account" class="account"></div>
        </div>
    </div>
    <div class="container">
        <center>
            <div id="feed" class="feed"></div>
            <div id="status-container">
                <textarea id="status" placeholder="Message to the Block"></textarea>
                <button id="publish"><i class="fas fa-paper-plane"></i></button>
            </div>
        </center>
    </div>
    <script type="module">
        import { createWeb3Modal, defaultWagmiConfig } from "https://esm.sh/@web3modal/wagmi@5.0.11/?bundle";
        import { bscTestnet } from "https://esm.sh/@wagmi/core@2.13.1/chains?exports=bscTestnet";
        import { disconnect, reconnect } from "https://esm.sh/@wagmi/core@2.13.1?exports=disconnect,reconnect";

        const projectId = "ea82e406480d9d8f524c7fe5c20cd367"; // Substitua por seu verdadeiro projectId
        const metadata = {
            name: "carlota",
            description: "",
            url: "",
            icons: ["https://avatars.githubusercontent.com/u/37784886"],
        };

        const chains = [bscTestnet];
        const config = defaultWagmiConfig({
            chains,
            projectId,
            metadata,
        });

        const contractAddress = '0x0dab011a9bf93cb45ad846dd9ca3e09261923aa3';
        const contractABI = [
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
                    { "indexed": false, "internalType": "string", "name": "text", "type": "string" },
                    { "indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256" }
                ],
                "name": "NewMessage",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "getMessages",
                "outputs": [
                    {
                        "components": [
                            { "internalType": "address", "name": "user", "type": "address" },
                            { "internalType": "string", "name": "text", "type": "string" },
                            { "internalType": "uint256", "name": "timestamp", "type": "uint256" }
                        ],
                        "internalType": "struct SocialDApp.Message[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "", "type": "uint256" }
                ],
                "name": "messages",
                "outputs": [
                    { "internalType": "address", "name": "user", "type": "address" },
                    { "internalType": "string", "name": "text", "type": "string" },
                    { "internalType": "uint256", "name": "timestamp", "type": "uint256" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "string", "name": "_text", "type": "string" }
                ],
                "name": "publishStatus",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        async function connectWallet() {
            try {
                const modal = createWeb3Modal({
                    wagmiConfig: config,
                    projectId,
                });
                const instance = await modal.connect();
                const web3 = new Web3(instance);
                const contract = new web3.eth.Contract(contractABI, contractAddress);

                const accounts = await web3.eth.getAccounts();
                document.getElementById('account').textContent = accounts[0];

                document.getElementById('publish').addEventListener('click', async () => {
                    const statusText = document.getElementById('status').value;
                    if (statusText) {
                        try {
                            await contract.methods.publishStatus(statusText).send({ from: accounts[0] });
                            console.log("Status publicado:", statusText);
                        } catch (error) {
                            console.error("Erro ao publicar status:", error);
                        }
                    } else {
                        console.error("Nenhum texto encontrado na área de texto.");
                    }
                });

                contract.events.NewMessage().on('data', (event) => {
                    console.log("Novo evento recebido:", event);
                    // Adicione lógica para exibir a mensagem no feed
                });
            } catch (error) {
                console.error("Erro ao conectar carteira:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            const connectButton = document.getElementById('connect');
            if (connectButton) {
                connectButton.addEventListener('click', connectWallet);
            } else {
                console.error("Elemento 'connect' não encontrado.");
            }
        });
    </script>
</body>
</html>
